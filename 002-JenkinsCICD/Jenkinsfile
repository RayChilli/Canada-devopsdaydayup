pipeline {
    agent any 
    environment{
        registryUrlBase = "https://ghcr.io"
        registryUrl = "ghcr.io/chance2021/devopsdaydayup"
        registryCredentialsId = 'github-token'
        commitID = sh(script: 'git rev-parse --short HEAD', returnStdout:true).trim()
        containerName = "color-web"
    }
    stages {
        stage('Build and Push Image') { 
            steps {
                // 
                sh"whoami"
                script {
                    docker.withRegistry(registryUrlBase, registryCredentialsId) {
                        dockerImage = docker.build("$registryUrl:$commitID","./002-JenkinsCICD")
			dockerImage.push()
                    }
                }
            }
        }
        stage('Cleaning Up') { 
            steps {
                sh "docker rmi --force $registryUrl:$commitID"
            }
        }
        stage('Deploy') { 
            steps {
                sh "docker stop $containerName", returnStatus: true
                sh "docker rm $containerName", returnStatus: true
                sh "docker run -d --name $containerName $registryUrl:$commitID"
            }
        }
    }
}
